<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Events</title>
  </head>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }

    /* CSS for the error message */
    .error-message {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: red;
      font-size: 14px;
      display: none; /* Initially hide the error message */
    }

    /* CSS for the error message and the cool box */
    .error-box {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: #ff6b6b; /* Background color for the cool box */
      border: 1px solid #ff0000; /* Border color for the cool box */
      color: #fff; /* Text color for the error message */
      border-radius: 5px; /* Rounded corners for the cool box */
      padding: 10px;
      font-size: 14px;
      display: none; /* Initially hide the error box */
      opacity: 0; /* Make the box transparent */
      transition: opacity 0.5s, transform 0.5s; /* Smooth transition for opacity and transform */
      transform: translateX(-100%); /* Move the box to the left */
    }

    /* Add styles for the custom class "show-details-button" */
    .show-details-button {
      background-color: #007bff; /* Change the button background color as needed */
      color: #fff; /* Change the button text color as needed */
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px; /* Add spacing between the button and event card content */
    }

    .show-details-button:hover {
      background-color: #0056b3; /* Change the button hover background color as needed */
    }

    /* ROLE */
    .roles-container {
      margin-top: 20px;
    }

    .role {
      margin-bottom: 10px;
    }

    .role p {
      font-weight: bold;
      margin: 0;
    }

    /* Style for the role cards */
    .role-card {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .role-card h3 {
      font-size: 1.2rem;
      margin: 0;
      color: #333;
    }

    .role-card p {
      font-size: 1rem;
      margin: 10px 0;
      color: #666;
    }
    .count {
      font-size: 0.9rem;
      color: #333;
      margin-top: 5px;
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
      font-size: 16px;
      color: #333; /* Color of the counts */
    }

    /* STATUS BARS */
    .status-bar {
      background-color: #4caf50; /* Green color for status bar */
      height: 10px; /* Set the height of the status bar */
      width: 0; /* Initial width is 0, will be updated dynamically */
      margin-top: 5px;
      border-radius: 5px;
      transition: width 0.5s; /* Add a transition for smooth width change */
    }

    .status-fill {
      background-color: #4caf50; /* Green color for fill */
      height: 100%;
      transition: width 1s; /* Add a transition for smooth filling animation */
    }

    /* EVENTS */
    .event-container {
      display: grid; /* Use CSS Grid for the event cards */
      grid-template-columns: repeat(
        auto-fill,
        minmax(300px, 1fr)
      ); /* Create a responsive grid */
      grid-gap: 20px; /* Add some spacing between cards */
      justify-items: center; /* Center the cards horizontally in the grid */
    }

    .event-card {
      width: 250px; /* Set a fixed width for each event card */
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .event-card h2 {
      font-size: 18px;
      margin: 0 0 10px;
    }

    .event-card p {
      font-size: 14px;
      margin: 0;
    }

    /* TOTAL INFO */

    .total-info {
      text-align: center;
      position: relative;
      top: 50%;
      left: 50%;
      padding: 20px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      width: 200px; /* Adjust the width to create a square box */
    }

    .total-info h2 {
      font-size: 24px;
      margin: 0 0 10px;
    }

    /* TOTAL PROGRESS */
    .total-progress-container {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .total-progress-bar {
      background-color: #eee;
      height: 10px;
      border-radius: 5px;
      flex: 1;
    }

    .total-progress-fill {
      width: 0;
      height: 100%;
      background-color: #4caf50;
      border-radius: 5px;
      transition: width 0.5s;
    }

    .total-progress-numbers {
      font-size: 18px; /* Increase font size for impact */
      margin: 0;
      font-weight: 700; /* Use a bolder font weight for emphasis */
      color: #4caf50; /* Apply a green color for a positive effect */
    }

    /* TOTAL ROLES */
    .total-roles {
      font-size: 20px;
      color: #4caf50;
      font-weight: bold;
    }

    /* MODAL */
    .event-details-modal {
      display: none; /* Hide the modal by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(
        0,
        0,
        0,
        0.7
      ); /* Semi-transparent black background */
      z-index: 1;
      overflow: auto;
    }

    .modal-content {
      background-color: #fefefe; /* White background for the modal */
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      border-radius: 5px;
      width: 60%; /* Adjust the width as needed */
    }

    .close-button {
      color: #888;
      float: right;
      font-size: 30px;
      cursor: pointer;
    }

    .close-button:hover {
      color: #000;
    }

    /* Center the modal content */
    .modal-content {
      text-align: center;
    }

    /* PROGRESS */
    .progress-container {
      width: 100%;
      display: flex;
      align-items: center; /* Center numbers vertically */
      justify-content: space-between;
      margin-top: 10px;
    }

    .progress-container p {
      font-size: 14px;
      margin: 0;
      font-weight: bold;
    }

    .progress-bar {
      width: 100%;
      background-color: #eee;
      height: 10px;
      border-radius: 5px;
      margin-top: 10px;
      flex: 1; /* Expand to fill available space */
      margin-right: 10px; /* Add spacing between progress bar and numbers */
      position: relative;
      bottom: 0;
    }

    .progress-fill {
      width: 0;
      height: 100%;
      background-color: #4caf50;
      border-radius: 5px;
      transition: width 0.5s; /* Add transition for smoother progress bar updates */
    }

    .progress-numbers {
      font-size: 18px; /* Increase font size for impact */
      margin: 0;
      font-weight: 700; /* Use a bolder font weight for emphasis */
      color: #4caf50; /* Apply a green color for a positive effect */
    }
  </style>

  <body>
    <div class="event-container" id="event-container">
      <!-- Events will be dynamically generated here -->
    </div>
    <div id="total-info" class="total-info">
      <h2>Total Roles Needed:</h2>
      <div class="total-progress-container">
        <div class="total-progress-bar">
          <div class="total-progress-fill"></div>
        </div>
        <p class="total-progress-numbers">(0/0)</p>
      </div>
    </div>

    <!-- Event Details Modal -->
    <div id="event-details-modal" class="event-details-modal">
      <div class="modal-content">
        <span class="close-button" id="close-button">&times;</span>
        <h3 id="event-details-title"></h3>
        <div id="event-details-content">
          <!-- Event details will be displayed here -->
        </div>
      </div>
    </div>
    <!-- Add an error message element -->
    <!-- Cool box for error message -->
    <div class="error-box">
      <p id="error-message" class="error-message"></p>
    </div>
  </body>
  <script>
    const eventContainer = document.getElementById("event-container");
    const totalRolesElement = document.querySelector(".total-info");
    const totalProgressBar = document.querySelector(".total-progress-fill");
    const totalNumbersElement = document.querySelector(
      ".total-progress-numbers"
    );
    const errorBox = document.querySelector(".error-box"); // Add error box element
    const EventDetailsmodal = document.getElementById("event-details-modal");

    // Function to create event cards
    function createEventCard(event) {
      const card = document.createElement("div");
      card.classList.add("event-card");
      const roles = event.roles;
      const roles_min = roles.reduce(
        (total, role) => total + role.min_count,
        0
      );
      const roles_now = roles.reduce((total, role) => total + role.count, 0);
      // Check if roles_min and roles_now are valid numbers, and provide default values if they are not.
      const rolesMinText = Number.isNaN(roles_min) ? 0 : roles_min;
      const rolesNowText = Number.isNaN(roles_now) ? 0 : roles_now;

      card.innerHTML = `
    <h2>${event.title_fi}</h2>
    <p>Date: ${event.date}</p>
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${
              roles_min > 0 ? (roles_now / roles_min) * 100 : 0
            }%;"></div>
        </div>
    </div>
    <p class="progress-numbers">(${roles_now}/${roles_min})</p>
    <button class="event-details-button" data-event-id="${
      event._id
    }">View Details</button>
`;

      // Add a custom class to the "View Details" button
      const button = card.querySelector(".event-details-button");
      button.classList.add("show-details-button");

      return card;
    }

    function displayEventDetails(eventDetails) {
      const modal = document.getElementById("event-details-modal");
      const titleElement = document.getElementById("event-details-title");
      const contentElement = document.getElementById("event-details-content");

      // Clear the previous content
      titleElement.textContent = "";
      contentElement.innerHTML = "";

      // Set the title of the modal
      titleElement.textContent = eventDetails.title_fi;

      // Create and append content to the modal
      const descriptionElement = document.createElement("p");
      descriptionElement.textContent = eventDetails.description_fi;

      const dateElement = document.createElement("p");
      dateElement.textContent = `Date: ${eventDetails.date}`;

      const locationElement = document.createElement("p");
      locationElement.textContent = `Location: ${eventDetails.location_fi}`;

      // Create role cards and status bars for each role
      eventDetails.roles.forEach((role) => {
        const roleCard = document.createElement("div");
        roleCard.classList.add("role-card");

        const roleName = document.createElement("h3");
        roleName.textContent = role.fi_name;

        const roleDescription = document.createElement("p");
        roleDescription.textContent = role.fi_description;

        const statusBar = document.createElement("div");
        statusBar.classList.add("status-bar");
        const statusFill = document.createElement("div");
        statusFill.classList.add("status-fill");
        statusFill.style.width = `${(role.count / role.min_count) * 100}%`; // Fill width based on data
        statusBar.appendChild(statusFill);

        const roleCount = document.createElement("p");
        roleCount.classList.add("count");
        roleCount.textContent = `(${role.count}/${role.min_count})`;

        roleCard.appendChild(roleName);
        roleCard.appendChild(roleDescription);
        roleCard.appendChild(statusBar);
        roleCard.appendChild(roleCount);

        contentElement.appendChild(roleCard);
      });

      // Append all content elements to the modal
      contentElement.appendChild(descriptionElement);
      contentElement.appendChild(dateElement);
      contentElement.appendChild(locationElement);

      // Show the modal
      modal.style.display = "block";
    }
    // Event listener to handle the button click
    eventContainer.addEventListener("click", (event) => {
      if (event.target.classList.contains("show-details-button")) {
        const eventId = event.target.getAttribute("data-event-id");
        // Fetch event data from /api/events/event_id (replace with your actual URL)
        fetch(`https://sinimustaahallitustavastaan.org/api/events/${eventId}`)
          .then((response) => response.json())
          .then((data) => {
            // Display event details in the modal
            displayEventDetails(data);
          })
          .catch((error) => {
            console.error("Error fetching event data:", error);
          });
      }
    });

    // Function to close the modal
    function closeModal() {
      const modal = document.getElementById("event-details-modal");
      modal.style.display = "none";
    }

    // Close the modal when the close button is clicked
    const closeButton = document.getElementById("close-button");
    closeButton.addEventListener("click", closeModal);

    // Close the modal when the user clicks outside of it
    window.addEventListener("click", (event) => {
      if (event.target === eventDetailsModal) {
        closeModal();
      }
    });

    // Function to fetch and update event data
    function updateEventData() {
      errorBox.style.display = "none";

      fetch("https://sinimustaahallitustavastaan.org/api/events/")
        .then((response) => response.json())
        .then((data) => {
          const eventData = data;
          eventContainer.innerHTML = "";
          updateTotalRoles(eventData);

          eventData.forEach((event) => {
            const card = createEventCard(event);
            eventContainer.appendChild(card);
          });
        })
        .catch((error) => {
          console.error("Error fetching event data:", error);
          errorBox.textContent = "Failed to fetch data from the server.";
          errorBox.style.display = "block";
        });
    }

    // Event listener to handle the button click
    eventContainer.addEventListener("click", (event) => {
      if (event.target.classList.contains("event-details-button")) {
        const eventId = event.target.getAttribute("data-event-id");
        // Fetch details for the specific event using `/api/events/<event_id>`
        fetch(`https://sinimustaahallitustavastaan.org/api/events/${eventId}`)
          .then((response) => response.json())
          .then((eventDetails) => {
            // Process and display the event details (e.g., role statistics or participants)
            // You can create a modal or a new section on the page to display the details.
            // Update the DOM with the event details.
            displayEventDetails(eventDetails);
          })
          .catch((error) => {
            console.error("Error fetching event details:", error);
          });
      }
    });

    // Function to update total roles and progress bar
    function updateTotalRoles(eventData) {
      let totalRolesMin = 0;
      let totalRolesNow = 0;

      eventData.forEach((event) => {
        totalRolesMin += event.roles.reduce(
          (total, role) => total + role.min_count,
          0
        );
        totalRolesNow += event.roles.reduce(
          (total, role) => total + role.count,
          0
        );
      });

      totalNumbersElement.textContent = `(${totalRolesNow}/${totalRolesMin})`;

      const totalPercentage =
        totalRolesMin > 0 ? (totalRolesNow / totalRolesMin) * 100 : 0;
      totalProgressBar.style.width = totalPercentage + "%";
    }

    // Function to hide the error box
    function hideErrorBox() {
      errorBox.style.opacity = 0;
      errorBox.style.transform = "translateX(-100%)";
      setTimeout(() => {
        errorBox.style.display = "none";
      }, 500); // Adjust the duration as needed
    }

    // Function to fetch and update event data
    function updateEventData() {
      // Fetch event data from the API
      fetch("https://sinimustaahallitustavastaan.org/api/events/")
        .then((response) => response.json())
        .then((data) => {
          const eventData = data; // Assuming the API response is an array of events
          // Clear the existing event cards
          eventContainer.innerHTML = "";

          eventData.forEach((event) => {
            const card = createEventCard(event);
            eventContainer.appendChild(card);
          });

          // Update the total roles information
          updateTotalRoles(eventData);

          hideErrorBox();
        })

        .catch((error) => {
          console.error("Error fetching event data:", error);
          // Display the error box with a smooth appearance
          errorBox.textContent = "Failed to fetch data from the server.";
          errorBox.style.display = "block";
          errorBox.style.opacity = 1;
          errorBox.style.transform = "translateX(0)";
        });
    }
    // Initial data load
    updateEventData();

    // Set up automatic updates every 5 minutes (adjust the interval as needed)
    setInterval(updateEventData, 1000); // 300,000 milliseconds = 5 minutes

    // CSS transition for number updates
    const animateNumbers = document.querySelectorAll(".animate-number");
    animateNumbers.forEach((number) => {
      number.style.transition = "color 0.5s, font-size 0.5s";
    });
  </script>
</html>
